#!/bin/bash

# Frontend Pre-commit Hook - CarePro Vite Project
# This script runs before every commit to ensure code quality and prevent broken code from entering the repository

set -e  # Exit on any error

# Color codes for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the project directory (frontend/vite-project)
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
echo -e "${BLUE}ğŸ—ï¸  Running Frontend Pre-commit Checks in: $PROJECT_DIR${NC}"

# Change to project directory
cd "$PROJECT_DIR"

# Function to print section headers
print_section() {
    echo
    echo -e "${BLUE}$1${NC}"
    echo "=================================================="
}

# Function to handle errors
handle_error() {
    echo -e "${RED}âŒ Pre-commit check failed: $1${NC}"
    echo -e "${RED}ğŸš« COMMIT REJECTED - Please fix the issues above before committing${NC}"
    exit 1
}

print_section "ğŸ” 1. LINTING CHECK (WARNING ONLY)"
echo -e "${YELLOW}Running ESLint to check code quality...${NC}"
if npm run lint; then
    echo -e "${GREEN}âœ… Linting passed${NC}"
else
    echo -e "${YELLOW}âš ï¸  Linting issues found - continuing anyway (fix these gradually)${NC}"
fi

print_section "ğŸ§ª 2. RUNNING TESTS (WARNING ONLY)"
echo -e "${YELLOW}Running Jest tests...${NC}"
if npm test -- --passWithNoTests --watchAll=false; then
    echo -e "${GREEN}âœ… All tests passed${NC}"
else
    echo -e "${YELLOW}âš ï¸  Some tests failed - continuing anyway (fix these gradually)${NC}"
fi

print_section "ğŸ—ï¸  3. BUILD CHECK"
echo -e "${YELLOW}Checking if the project builds successfully...${NC}"
if npm run build; then
    echo -e "${GREEN}âœ… Build successful${NC}"
    # Clean up build directory to keep repo clean
    rm -rf dist/
else
    handle_error "Build failed"
fi

print_section "ğŸ”’ 4. SECURITY AUDIT"
echo -e "${YELLOW}Running npm security audit...${NC}"
if npm audit --audit-level=high; then
    echo -e "${GREEN}âœ… No high-severity security vulnerabilities found${NC}"
else
    echo -e "${YELLOW}âš ï¸  Security vulnerabilities detected. Please review and fix.${NC}"
    echo -e "${YELLOW}ğŸ’¡ Run 'npm audit fix' to automatically fix issues${NC}"
    handle_error "Security audit failed"
fi

print_section "ğŸ“¦ 5. DEPENDENCY CHECK"
echo -e "${YELLOW}Checking for missing dependencies...${NC}"
if npm ls --depth=0 > /dev/null 2>&1; then
    echo -e "${GREEN}âœ… All dependencies are properly installed${NC}"
else
    echo -e "${YELLOW}âš ï¸  Some dependencies might be missing or outdated${NC}"
    echo -e "${YELLOW}ğŸ’¡ Run 'npm install --legacy-peer-deps' to fix dependency issues${NC}"
    handle_error "Dependency check failed"
fi

print_section "ğŸ¯ 6. TYPESCRIPT CHECK (if applicable)"
if [ -f "tsconfig.json" ]; then
    echo -e "${YELLOW}Running TypeScript type checking...${NC}"
    if npx tsc --noEmit; then
        echo -e "${GREEN}âœ… TypeScript check passed${NC}"
    else
        handle_error "TypeScript type checking failed"
    fi
else
    echo -e "${YELLOW}ğŸ“ No tsconfig.json found, skipping TypeScript check${NC}"
fi

# Final success message
echo
echo -e "${GREEN}ğŸ‰ ALL PRE-COMMIT CHECKS PASSED!${NC}"
echo -e "${GREEN}âœ… Your frontend code is ready to be committed${NC}"
echo -e "${BLUE}ğŸ“‹ Summary of checks completed:${NC}"
echo -e "   â€¢ Code linting (ESLint)"
echo -e "   â€¢ Unit/Integration tests (Jest)"
echo -e "   â€¢ Build verification (Vite)"
echo -e "   â€¢ Security audit (npm audit)"
echo -e "   â€¢ Dependency verification"
echo -e "   â€¢ TypeScript type checking"
echo
