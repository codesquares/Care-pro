name: üöÄ CarePro Staging Deployment Pipeline

on:
  push:
    branches: [ staging ]
    paths:
      - 'frontend/vite-project/**'
      - 'docker-compose.yml'
      - '.github/workflows/staging-deployment.yml'
  pull_request:
    branches: [ staging ]
    paths:
      - 'frontend/vite-project/**'
      - 'docker-compose.yml'
      - '.github/workflows/staging-deployment.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '22'
  AWS_REGION: 'us-east-1'
  ECR_REPOSITORY_FRONTEND: 'carepro-frontend-staging'
  # NODE-API REMOVED: No longer deploying to AppRunner
  # ECR_REPOSITORY_NODEAPI: 'carepro-node-api-staging'
  # APP_RUNNER_SERVICE_NAME: 'carepro-node-api-staging'
  S3_BUCKET: 'carepro-frontend-staging'

jobs:
  # üîí SECURITY AND QUALITY GATES
  security-quality-gates:
    name: üîí Security & Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/vite-project/package-lock.json

      - name: üîç Check for merge conflicts
        run: |
          echo "üîç Checking for merge conflicts..."
          if grep -r "^<<<<<<< \|^>>>>>>> \|^=======" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules; then
            echo "‚ùå Merge conflicts found! Please resolve them first."
            exit 1
          fi
          echo "‚úÖ No merge conflicts detected"

      - name: üîí Audit Frontend Dependencies
        working-directory: frontend/vite-project
        run: |
          echo "üîí Auditing frontend dependencies..."
          npm ci
          echo "üîç Running security audit (only blocking on high/critical vulnerabilities)..."
          npm audit --audit-level=high --omit=dev || echo "‚ö†Ô∏è Moderate vulnerabilities found but allowing deployment"
          echo "‚úÖ Security audit completed"

      # NODE-API AUDIT REMOVED: No longer deploying node-API to AppRunner
      # - name: üîí Audit Node-API Dependencies (BLOCKING)
      #   working-directory: node-API
      #   run: |
      #     echo "üîç Auditing Node-API dependencies..."
      #     npm ci
      #     echo "üîç Running security audit (STRICT MODE)..."
      #     npm audit --audit-level=moderate
      #     echo "‚úÖ Security audit completed - no vulnerabilities found"

      - name: üßπ Frontend Linting
        working-directory: frontend/vite-project
        run: |
          echo "üîç Running frontend linting..."
          npm run lint || echo "‚ö†Ô∏è Linting warnings found but continuing for staging"

  # üß™ FRONTEND TESTS AND BUILD
  frontend-staging-tests:
    name: üé® Frontend Tests & Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: security-quality-gates

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/vite-project/package-lock.json

      - name: Install dependencies
        working-directory: frontend/vite-project
        run: npm ci

      - name: üß™ Run Frontend Tests
        working-directory: frontend/vite-project
        run: |
          echo "üß™ Running frontend tests..."
          npm run test:coverage || echo "‚ö†Ô∏è Test warnings but continuing for staging"
        env:
          CI: true

      - name: üèóÔ∏è Build Frontend for Staging
        working-directory: frontend/vite-project
        run: |
          echo "üèóÔ∏è Building frontend for staging..."
          npm run build
        env:
          VITE_CONTENTFUL_SPACE_ID: ${{ secrets.VITE_CONTENTFUL_SPACE_ID }}
          VITE_CONTENTFUL_ACCESS_TOKEN_PUBLISHED: ${{ secrets.VITE_CONTENTFUL_ACCESS_TOKEN_PUBLISHED }}
          VITE_CONTENTFUL_ACCESS_TOKEN_DRAFT: ${{ secrets.VITE_CONTENTFUL_ACCESS_TOKEN_DRAFT }}
          VITE_CONTENTFUL_ENVIRONMENT: master
          VITE_PRODUCTION_API_URL: https://api.oncarepro.com/api
          VITE_STAGING_API_URL: https://staging.api.oncarepro.com/api
          VITE_LOCAL_API_URL: http://localhost:5005/api
          VITE_DOJAH_WIDGET_ID: ${{ secrets.VITE_DOJAH_WIDGET_ID_STAGING }}
          VITE_DOJAH_APP_ID: ${{ secrets.VITE_DOJAH_APP_ID_STAGING }}
          VITE_DOJAH_PUBLIC_KEY: ${{ secrets.VITE_DOJAH_PUBLIC_KEY }}
          VITE_DEBUG: true
          VITE_REDIRECT_URL: https://carepro-frontend-staging.s3-website-us-east-1.amazonaws.com/app/caregiver/dashboard
          VITE_ENV: staging

      - name: üì¶ Upload Frontend Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-staging-build
          path: frontend/vite-project/dist/
          retention-days: 7



  # üê≥ DOCKER BUILD AND PUSH (Frontend Only)
  docker-build-push:
    name: üê≥ Docker Build & Push to ECR
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [frontend-staging-tests]
    if: ${{ success() || github.event.inputs.force_deploy == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Frontend Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-staging-build
          path: frontend/vite-project/dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üèóÔ∏è Build Frontend Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üèóÔ∏è Building frontend Docker image..."
          cd frontend/vite-project
          docker build \
            --build-arg VITE_CONTENTFUL_SPACE_ID=${{ secrets.VITE_CONTENTFUL_SPACE_ID }} \
            --build-arg VITE_CONTENTFUL_ACCESS_TOKEN_PUBLISHED=${{ secrets.VITE_CONTENTFUL_ACCESS_TOKEN_PUBLISHED }} \
            --build-arg VITE_CONTENTFUL_ACCESS_TOKEN_DRAFT=${{ secrets.VITE_CONTENTFUL_ACCESS_TOKEN_DRAFT }} \
            --build-arg VITE_CONTENTFUL_ENVIRONMENT=master \
            --build-arg VITE_PRODUCTION_API_URL=https://api.oncarepro.com/api \
            --build-arg VITE_STAGING_API_URL=https://staging.api.oncarepro.com/api \
            --build-arg VITE_LOCAL_API_URL=http://localhost:5005/api \
            --build-arg VITE_DOJAH_WIDGET_ID=${{ secrets.VITE_DOJAH_WIDGET_ID_STAGING }} \
            --build-arg VITE_DOJAH_APP_ID=${{ secrets.VITE_DOJAH_APP_ID_STAGING }} \
            --build-arg VITE_DOJAH_PUBLIC_KEY=${{ secrets.VITE_DOJAH_PUBLIC_KEY }} \
            --build-arg VITE_DEBUG=true \
            --build-arg VITE_REDIRECT_URL=https://carepro-frontend-staging.s3-website-us-east-1.amazonaws.com/app/caregiver/dashboard \
            --build-arg VITE_ENV=staging \
            -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest \
            .
          echo "‚úÖ Frontend Docker image built successfully"

      # NODE-API BUILD REMOVED: No longer deploying to AppRunner
      # - name: üèóÔ∏è Build Node-API Docker Image
      #   env:
      #     ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      #     IMAGE_TAG: ${{ github.sha }}
      #   run: |
      #     echo "üèóÔ∏è Building Node-API Docker image..."
      #     cd node-API
      #     docker build \
      #       -t $ECR_REGISTRY/$ECR_REPOSITORY_NODEAPI:$IMAGE_TAG \
      #       -t $ECR_REGISTRY/$ECR_REPOSITORY_NODEAPI:latest \
      #       .
      #     echo "‚úÖ Node-API Docker image built successfully"

      - name: üöÄ Push Frontend Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üöÄ Pushing frontend image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest
          echo "‚úÖ Frontend image pushed successfully"

      # NODE-API PUSH REMOVED: No longer deploying to AppRunner
      # - name: üöÄ Push Node-API Image to ECR
      #   env:
      #     ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      #     IMAGE_TAG: ${{ github.sha }}
      #   run: |
      #     echo "üöÄ Pushing Node-API image to ECR..."
      #     docker push $ECR_REGISTRY/$ECR_REPOSITORY_NODEAPI:$IMAGE_TAG
      #     docker push $ECR_REGISTRY/$ECR_REPOSITORY_NODEAPI:latest
      #     echo "‚úÖ Node-API image pushed successfully"

  # üåê DEPLOY TO AWS STAGING
  deploy-staging:
    name: üåê Deploy to AWS Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: docker-build-push
    environment:
      name: staging
      url: https://budmfp9jxr.us-east-1.awsapprunner.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Frontend Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-staging-build
          path: ./frontend-build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üåê Deploy Frontend to S3
        run: |
          echo "üåê Deploying frontend to S3..."
          echo "üìÅ Checking downloaded artifacts..."
          ls -la ./frontend-build/
          # Sync the downloaded frontend build to S3
          aws s3 sync ./frontend-build/ s3://$S3_BUCKET --delete
          echo "‚úÖ Frontend deployed to S3 successfully"

      # APPRUNNER DEPLOYMENT REMOVED: No longer deploying node-API
      # - name: üî• Update App Runner Service
      # - name: ‚è≥ Wait for App Runner Deployment  
      # All AppRunner deployment logic has been removed

      - name: ü©∫ Health Check
        run: |
          echo "ü©∫ Performing health checks..."
          
          # NODE-API HEALTH CHECK REMOVED: No longer deploying to AppRunner
          # curl -f https://budmfp9jxr.us-east-1.awsapprunner.com/api/health
          
          # Check frontend availability
          echo "Checking frontend availability..."
          curl -f http://carepro-frontend-staging.s3-website-us-east-1.amazonaws.com || echo "‚ö†Ô∏è Frontend health check failed"
          
          echo "‚úÖ Health checks completed"

  # üìß EMAIL NOTIFICATIONS
  notify-success:
    name: üìß Success Notification
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: success()

    steps:
      - name: üìß Send Success Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ CarePro Staging Deployment Successful - ${{ github.sha }}"
          body: |
            üéâ CarePro Staging Deployment Completed Successfully!
            
            üìã Deployment Details:
            ‚Ä¢ Branch: ${{ github.ref_name }}
            ‚Ä¢ Commit: ${{ github.sha }}
            ‚Ä¢ Triggered by: ${{ github.actor }}
            ‚Ä¢ Deployment Time: ${{ github.event.head_commit.timestamp }}
            
            üåê Staging URLs:
            ‚Ä¢ Frontend: http://carepro-frontend-staging.s3-website-us-east-1.amazonaws.com
            ‚Ä¢ Backend API: Managed separately (Azure App Service)
            
            ‚úÖ Services Status:
            ‚Ä¢ Frontend: Deployed to S3
            ‚Ä¢ Docker Image: Pushed to ECR
            
            üîó GitHub Actions: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: CarePro CI/CD <${{ secrets.EMAIL_USERNAME }}>

  notify-failure:
    name: üìß Failure Notification
    runs-on: ubuntu-latest
    needs: [security-quality-gates, frontend-staging-tests, docker-build-push, deploy-staging]
    if: ${{ always() && (failure() || cancelled()) }}

    steps:
      - name: üìß Send Failure Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå CarePro Staging Deployment Failed - ${{ github.sha }}"
          body: |
            ‚ùå CarePro Staging Deployment Failed!
            
            üìã Failure Details:
            ‚Ä¢ Branch: ${{ github.ref_name }}
            ‚Ä¢ Commit: ${{ github.sha }}
            ‚Ä¢ Triggered by: ${{ github.actor }}
            ‚Ä¢ Failure Time: ${{ github.event.head_commit.timestamp }}
            
            üîç Check the following:
            ‚Ä¢ Security vulnerabilities in dependencies
            ‚Ä¢ Test failures (frontend/backend)
            ‚Ä¢ Docker build issues
            ‚Ä¢ AWS deployment problems
            
            üîó View Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ‚ö†Ô∏è Staging environment may be in an inconsistent state.
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: CarePro CI/CD <${{ secrets.EMAIL_USERNAME }}>